name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to DigitalOcean Droplet
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DROPLET_HOST }}
        username: ${{ secrets.DROPLET_USER }}
        key: ${{ secrets.DROPLET_SSH_KEY }}
        script: |
          # Navigate to app directory
          cd /opt/dmarc-analyzer || (sudo mkdir -p /opt/dmarc-analyzer && cd /opt/dmarc-analyzer && sudo chown $USER:$USER /opt/dmarc-analyzer)
          
          # Clone or update repository
          if [ -d ".git" ]; then
            echo "Updating existing repository..."
            git pull origin main
          else
            echo "Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # Setup environment variables for backend
          cat > backend/.env << 'EOF'
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EOF
          
          # Setup environment variables for frontend
          cat > frontend/.env.local << 'EOF'
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          EOF
          
          # Make start script executable
          chmod +x start_servers.sh
          
          # Stop any existing services
          ./start_servers.sh stop || true
          
          # Setup backend dependencies
          echo "Setting up backend..."
          cd backend
          
          # Create virtual environment if it doesn't exist
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi
          
          # Activate virtual environment and install dependencies
          source .venv/bin/activate
          pip install -r requirements.txt
          
          cd ..
          
          # Setup frontend dependencies
          echo "Setting up frontend..."
          cd frontend
          
          # Install dependencies
          npm ci
          
          # Build the application
          npm run build
          
          cd ..
          
          # Start both services using our proven script
          ./start_servers.sh start
          
          # Show status
          echo "Deployment complete!"
          ./start_servers.sh status 